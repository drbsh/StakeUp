{% extends 'base.html' %}
{% load static %}
{% block title %}Регистрация{% endblock %}
{% block content %}
<!-- Шапка (fixed, как на всех страницах) -->
<header class="navbar">
    <a href="{% url 'projects:index' %}" class="logo-link">
        <img src="{% static 'Image/s.png' %}" alt="s" class="stakeup">
    </a>
    <a href="{% url 'projects:index' %}">Главная</a>
    <a href="{% url 'projects:projects_list' %}">Проекты</a>
    <a href="{% url 'projects:login' %}">Вход</a>
</header>

<!-- Основной контент -->
<div class="page" style="padding-top: 120px; padding-bottom: 80px;">
    <div style="max-width: 500px; width: 100%; padding: 0 80px; text-align: center;">
        <h1 style="font-size: 42px; font-weight: 700; color: #000; margin: 0 0 16px;">Регистрация</h1>
        <p style="font-size: 36px; font-weight: 700; color: #999; margin: 0 0 40px;">Создайте аккаунт</p>
        <div style="display: flex; flex-direction: column; gap: 16px; margin-bottom: 32px;">
            <input type="text" id="id_username" class="login-input" placeholder="Логин">

            <div style="position: relative;">
                <input type="password" id="id_password" class="login-input" placeholder="Пароль" style="padding-right: 50px;">
                <img src="{% static 'Image/hide.png' %}"
                     class="toggle-password"
                     data-target="id_password"
                     data-state="hidden"
                     data-show-src="{% static 'Image/show.png' %}"
                     data-hide-src="{% static 'Image/hide.png' %}"
                     alt="Показать пароль"
                     style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); cursor: pointer; width: 20px; height: 20px;"
                >
            </div>

            <div style="position: relative;">
                <input type="password" id="id_password2" class="login-input" placeholder="Повторите пароль" style="padding-right: 50px;">
                <img src="{% static 'Image/hide.png' %}"
                     class="toggle-password"
                     data-target="id_password2"
                     data-state="hidden"
                     data-show-src="{% static 'Image/show.png' %}"
                     data-hide-src="{% static 'Image/hide.png' %}"
                     alt="Показать пароль"
                     style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); cursor: pointer; width: 20px; height: 20px;"
                >
            </div>
        </div>

        <button id="register-btn" class="btn btn-primary" style="width: 100%; padding: 14px;">
            Зарегистрироваться
        </button>

        <p class="agreePageEnter" style="
            font-size: 14px;
            color: #999;
            margin-top: 24px;
            line-height: 1.5;
        ">
            Продолжая, вы соглашаетесь на обработку персональных данных,<br>
            а также принимаете условия пользовательского соглашения
        </p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ===================================
    // ТОЛЬКО кнопка регистрации
    // Переключатель пароля работает через глобальный скрипт из base.html
    // ===================================
    document.getElementById('register-btn').addEventListener('click', async function(e) {
        e.preventDefault();

        const username = document.getElementById('id_username').value.trim();
        const password = document.getElementById('id_password').value;
        const password2 = document.getElementById('id_password2').value;

        // Валидация на фронтенде
        if (!username || !password || !password2) {
            alert('Заполните все поля');
            return;
        }

        if (password.length < 8) {
            alert('Пароль должен содержать минимум 8 символов');
            return;
        }

        if (password !== password2) {
            alert('Пароли не совпадают');
            return;
        }

        // Отключаем кнопку во время загрузки
        const originalBtnText = this.innerHTML;
        this.disabled = true;
        this.innerHTML = '<span style="display:inline-block;width:20px;height:20px;border:3px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;margin-right:8px;"></span> Регистрация...';

        try {
            const response = await fetch('/api/register/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    username: username,
                    password: password,
                    email: username.includes('@') ? username : undefined,
                }),
                credentials: 'same-origin'
            });

            const data = await response.json();

            if (response.ok) {
                // Сохраняем токен
                localStorage.setItem('token', data.token);
                localStorage.setItem('user', JSON.stringify(data.user));
                
                alert('Регистрация успешна! Добро пожаловать, ' + data.user.username + '!');
                window.location.href = '{% url "projects:index" %}';
            } else {
                alert('Ошибка регистрации:\n' + (data.detail || 'Неизвестная ошибка'));
                
                // Возвращаем кнопку в исходное состояние
                this.disabled = false;
                this.innerHTML = originalBtnText;
            }
        } catch (error) {
            console.error('Ошибка:', error);
            alert('Произошла ошибка при регистрации. Попробуйте позже.');
            
            // Возвращаем кнопку в исходное состояние
            this.disabled = false;
            this.innerHTML = originalBtnText;
        }
    });
});

// Функция получения CSRF токена
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

{% endblock %}