{% extends 'base.html' %}
{% load static %}
{% block title %}–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è{% endblock %}
{% block content %}
<!-- –®–∞–ø–∫–∞ -->
<header class="navbar">
    <a href="{% url 'projects:index' %}" class="logo-link">
        <img src="{% static 'Image/s.png' %}" alt="s" class="stakeup">
    </a>
    <a href="{% url 'projects:index' %}">–ì–ª–∞–≤–Ω–∞—è</a>
    <a href="{% url 'projects:projects_list' %}">–ü—Ä–æ–µ–∫—Ç—ã</a>
    <a href="{% url 'projects:login' %}">–í—Ö–æ–¥</a>
</header>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
<div class="page" style="padding-top: 90px; padding-bottom: 80px;">
    <div style="max-width: 500px; width: 100%; padding: 0 80px; text-align: center;">
        <h1 style="font-size: 42px; font-weight: 700; color: #000; margin: 0 0 16px;">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å</h1>
        
        <!-- ‚úÖ –¢–µ–∫—Å—Ç –ø–æ —Ü–µ–Ω—Ç—Ä—É, –±–µ–∑ –ø–µ—Ä–µ–Ω–æ—Å–∞, –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π -->
        <p style="font-size: 32px; font-weight: 700; color: #999; margin: 0 0 40px;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å </p>

        <!-- –§–æ—Ä–º–∞ -->
        <div style="display: flex; flex-direction: column; gap: 16px; margin-bottom: 32px;">
            <!-- üîπ –ü–æ–ª–µ –ª–æ–≥–∏–Ω–∞ -->
            <input type="text" id="id_identifier" class="login-input" placeholder="–õ–æ–≥–∏–Ω">

            <!-- üîπ –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å -->
            <div style="position: relative;">
                <input type="password" id="id_new_password" class="login-input" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" style="padding-right: 50px;">
                <img src="{% static 'Image/hide.png' %}"
                     class="toggle-password"
                     data-target="id_new_password"
                     data-state="hidden"
                     data-show-src="{% static 'Image/show.png' %}"
                     data-hide-src="{% static 'Image/hide.png' %}"
                     alt="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å"
                     style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); cursor: pointer; width: 20px; height: 20px;"
                >
            </div>

            <!-- üîπ –ü–æ–≤—Ç–æ—Ä –ø–∞—Ä–æ–ª—è -->
            <div style="position: relative;">
                <input type="password" id="id_confirm_password" class="login-input" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" style="padding-right: 50px;">
                <img src="{% static 'Image/hide.png' %}"
                     class="toggle-password"
                     data-target="id_confirm_password"
                     data-state="hidden"
                     data-show-src="{% static 'Image/show.png' %}"
                     data-hide-src="{% static 'Image/hide.png' %}"
                     alt="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å"
                     style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); cursor: pointer; width: 20px; height: 20px;"
                >
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div style="display: flex; flex-direction: column; gap: 16px; width: 100%;">
            <button id="reset-btn" class="btn btn-primary" style="width: 100%; padding: 14px;">
                –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å
            </button>
            <a href="{% url 'projects:login' %}" class="btn btn-secondary" style="width: 100%;">
                –ù–∞–∑–∞–¥
            </a>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // ===================================
    // –¢–û–õ–¨–ö–û –∫–Ω–æ–ø–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è
    // ===================================
    const identifierInput = document.getElementById('id_identifier');
    const newPasswordInput = document.getElementById('id_new_password');
    const confirmPasswordInput = document.getElementById('id_confirm_password');
    const submitBtn = document.getElementById('reset-btn');

    if (!identifierInput || !newPasswordInput || !confirmPasswordInput || !submitBtn) {
        console.warn('–û–¥–∏–Ω –∏–∑ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ñ–æ—Ä–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }

    submitBtn.addEventListener('click', async function (e) {
        e.preventDefault();

        const identifier = identifierInput.value.trim();
        const newPass = newPasswordInput.value;
        const confirmPass = confirmPasswordInput.value;

        if (!identifier || !newPass || !confirmPass) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è.');
            return;
        }

        if (newPass.length < 8) {
            alert('–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤.');
            return;
        }

        if (newPass !== confirmPass) {
            alert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç.');
            return;
        }

        // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É
        const originalBtnText = this.innerHTML;
        this.disabled = true;
        this.innerHTML = '<span style="display:inline-block;width:20px;height:20px;border:3px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;margin-right:8px;"></span> –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ...';

        try {
            console.log('=== –®–ê–ì 1: –ó–∞–ø—Ä–æ—Å /api/forgot-password/ ===');
            console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:', { identifier });

            // –®–∞–≥ 1: –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω —Å–±—Ä–æ—Å–∞
            const forgotRes = await fetch('/api/forgot-password/', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ identifier }),
                credentials: 'same-origin'
            });

            const forgotData = await forgotRes.json();

            console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', forgotRes.status);
            console.log('–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', forgotData);
            console.log('forgotData.uid:', forgotData.uid);
            console.log('forgotData.token:', forgotData.token);

            if (!forgotRes.ok) {
                alert(forgotData.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å —Å–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è.');
                this.disabled = false;
                this.innerHTML = originalBtnText;
                return;
            }

            // –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê: –µ—Å—Ç—å –ª–∏ —Ç–æ–∫–µ–Ω?
            if (!forgotData.uid || !forgotData.token) {
                console.error('‚ùå –û–®–ò–ë–ö–ê: –û—Ç–≤–µ—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç uid –∏–ª–∏ token!');
                console.error('–ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç:', forgotData);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ –æ—Ç–≤–µ—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ –±–µ–∑ —Ç–æ–∫–µ–Ω–∞
                if (forgotData.detail && forgotData.detail.includes('–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã')) {
                    alert('–ù–∞ –≤–∞—à—É –ø–æ—á—Ç—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è.');
                    window.location.href = '{% url "projects:login" %}';
                    return;
                }
                
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: –Ω–µ –ø–æ–ª—É—á–µ–Ω —Ç–æ–∫–µ–Ω —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è.');
                this.disabled = false;
                this.innerHTML = originalBtnText;
                return;
            }

            console.log('‚úÖ –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
            console.log('uid:', forgotData.uid);
            console.log('token:', forgotData.token);

            console.log('\n=== –®–ê–ì 2: –ó–∞–ø—Ä–æ—Å /api/reset-password/ ===');
            console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:', {
                uid: forgotData.uid,
                token: forgotData.token,
                new_password: '*** (—Å–∫—Ä—ã—Ç)',
                confirm_password: '*** (—Å–∫—Ä—ã—Ç)'
            });

            // –®–∞–≥ 2: –°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å
            const resetRes = await fetch('/api/reset-password/', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    uid: forgotData.uid,
                    token: forgotData.token,
                    new_password: newPass,
                    confirm_password: confirmPass
                }),
                credentials: 'same-origin'
            });

            const resetData = await resetRes.json();

            console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', resetRes.status);
            console.log('–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', resetData);

            if (resetRes.ok) {
                alert('–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏.');
                window.location.href = '{% url "projects:login" %}';
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (resetData.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                this.disabled = false;
                this.innerHTML = originalBtnText;
            }

        } catch (err) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', err);
            console.error('–°—Ç–µ–∫ –æ—à–∏–±–∫–∏:', err.stack);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
            this.disabled = false;
            this.innerHTML = originalBtnText;
        }
    });
});

// –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

{% endblock %}